#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

ROOT_DIR="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$ROOT_DIR"

usage() {
  cat <<'EOF'
Mario DevX

Usage:
  .mario/scripts/mario init [--force]
  .mario/scripts/mario prd [initial idea]
  .mario/scripts/mario plan
  .mario/scripts/mario build
  .mario/scripts/mario doctor

Notes:
  - Configure the agent + backpressure in .mario/AGENTS.md
  - State lives in .mario/
EOF
}

doctor() {
  local ok=1

  if [[ ! -d ".mario" ]]; then
    echo "FAIL: missing .mario/ (run install.sh)" >&2
    ok=0
  fi

  if [[ ! -f ".mario/AGENTS.md" ]]; then
    echo "FAIL: missing .mario/AGENTS.md" >&2
    ok=0
  fi

  if [[ ! -f "$SCRIPT_DIR/mario-loop.sh" ]]; then
    echo "FAIL: missing .mario/scripts/mario-loop.sh" >&2
    ok=0
  fi

  if [[ "$ok" == "0" ]]; then
    return 1
  fi

  echo "OK: basic files present" >&2
}

prd_interactive() {
  local initial_idea="${1:-}"
  local round=0

  mkdir -p ".mario/state" ".mario/runs" 2>/dev/null || true
  : > /dev/null

  if [[ -n "$initial_idea" ]]; then
    if [[ ! -f ".mario/state/feedback.md" ]]; then
      printf '%s\n' "Status: NONE" > ".mario/state/feedback.md"
    fi
    if ! grep -q "^Initial idea:" ".mario/state/feedback.md" 2>/dev/null; then
      {
        echo
        echo "Initial idea: $initial_idea"
      } >> ".mario/state/feedback.md"
    fi
  fi

  while true; do
    round=$((round + 1))
    out_file="$(mktemp -t mario-prd.XXXXXX)"

    # One PRD step (the loop script defaults to MAX_ITERATIONS=1 in prd mode).
    set +e
    bash "$SCRIPT_DIR/mario-loop.sh" prd 2>&1 | tee "$out_file"
    ec=${PIPESTATUS[0]}
    set -e

    if [[ "$ec" != "0" ]]; then
      echo "PRD run failed (exit $ec)." >&2
      rm -f "$out_file" || true
      return "$ec"
    fi

    # If the agent produced a PRD block, we consider it done.
    if grep -q "\[PRD\]" "$out_file" && grep -q "\[/PRD\]" "$out_file"; then
      rm -f "$out_file" || true
      return 0
    fi

    rm -f "$out_file" || true

    echo
    echo "Enter your answers for round $round (example: 1A, 2C, 3D)." >&2
    echo "Type 'q' to stop." >&2
    printf '> ' >&2
    IFS= read -r ans || true

    if [[ -z "$ans" || "$ans" == "q" || "$ans" == "quit" ]]; then
      return 0
    fi

    if [[ ! -f ".mario/state/feedback.md" ]]; then
      printf '%s\n' "Status: NONE" > ".mario/state/feedback.md"
    fi

    {
      echo
      echo "Answers (round $round):"
      echo "$ans"
    } >> ".mario/state/feedback.md"
  done
}

cmd_init() {
  if [[ -f "./install.sh" ]]; then
    bash ./install.sh "$@"
    return 0
  fi

  echo "No ./install.sh found in this repo." >&2
  echo "Run the remote installer from your project root:" >&2
  echo "  curl -fsSL https://raw.githubusercontent.com/valerio-mc/mario-devx/main/install.sh | bash" >&2
  return 2
}

cmd="${1:-}"
case "$cmd" in
  init)
    shift || true
    cmd_init "$@"
    ;;
  prd)
    shift || true
    prd_interactive "$*"
    ;;
  plan|build)
    shift || true
    exec bash "$SCRIPT_DIR/mario-loop.sh" "$cmd" "$@"
    ;;
  doctor)
    doctor
    ;;
  -h|--help|help|"")
    usage
    ;;
  *)
    echo "Unknown command: $cmd" >&2
    usage
    exit 2
    ;;
esac
