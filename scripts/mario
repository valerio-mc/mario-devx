#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

ROOT_DIR="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$ROOT_DIR"

usage() {
  cat <<'EOF'
Mario DevX

Usage:
  .mario/scripts/mario init [--force]
  .mario/scripts/mario prd [initial idea]
  .mario/scripts/mario plan
  .mario/scripts/mario build
  .mario/scripts/mario doctor

Notes:
  - Configure the agent + backpressure in .mario/AGENTS.md
  - State lives in .mario/
  - PRD runs in the OpenCode TUI (opencode-specific)
EOF
}

doctor() {
  local ok=1

  if [[ ! -d ".mario" ]]; then
    echo "FAIL: missing .mario/ (run install.sh)" >&2
    ok=0
  fi

  if [[ ! -f ".mario/AGENTS.md" ]]; then
    echo "FAIL: missing .mario/AGENTS.md" >&2
    ok=0
  fi

  if [[ ! -f "$SCRIPT_DIR/mario-loop.sh" ]]; then
    echo "FAIL: missing .mario/scripts/mario-loop.sh" >&2
    ok=0
  fi

  if [[ "$ok" == "0" ]]; then
    return 1
  fi

  echo "OK: basic files present" >&2
}

prd_tui() {
  local initial_idea="${1:-}"
  local prompt_file=".mario/prompts/PROMPT_prd.md"

  command -v opencode >/dev/null 2>&1 || {
    echo "Missing 'opencode' executable." >&2
    echo "Install OpenCode or use plan/build only." >&2
    return 2
  }

  [[ -f "$prompt_file" ]] || {
    echo "Missing $prompt_file" >&2
    echo "Run the installer again:" >&2
    echo "  curl -fsSL https://raw.githubusercontent.com/valerio-mc/mario-devx/main/install.sh | bash -- --force" >&2
    return 2
  }

  tmp_prompt="$(mktemp -t mario-prd-tui.XXXXXX)"
  {
    echo "# Mario DevX PRD Interview"
    echo
    if [[ -n "$initial_idea" ]]; then
      echo "Initial idea: $initial_idea"
      echo
    fi
    cat "$prompt_file"
  } > "$tmp_prompt"

  # Launch the OpenCode TUI in this project.
  # The PRD prompt is passed via --prompt; user interacts inside the TUI.
  opencode . --prompt "$(cat "$tmp_prompt")"
  rm -f "$tmp_prompt" || true
}

cmd_init() {
  if [[ -f "./install.sh" ]]; then
    bash ./install.sh "$@"
    return 0
  fi

  echo "No ./install.sh found in this repo." >&2
  echo "Run the remote installer from your project root:" >&2
  echo "  curl -fsSL https://raw.githubusercontent.com/valerio-mc/mario-devx/main/install.sh | bash" >&2
  return 2
}

cmd="${1:-}"
case "$cmd" in
  init)
    shift || true
    cmd_init "$@"
    ;;
  prd)
    shift || true
    prd_tui "$*"
    ;;
  plan|build)
    shift || true
    exec bash "$SCRIPT_DIR/mario-loop.sh" "$cmd" "$@"
    ;;
  doctor)
    doctor
    ;;
  -h|--help|help|"")
    usage
    ;;
  *)
    echo "Unknown command: $cmd" >&2
    usage
    exit 2
    ;;
esac
